<navigation-bar
  title="历史记录"
  back="{{true}}"
  color="black"
  background="#FFF">
</navigation-bar>

<view class="history-container">
  <!-- 页面标题和统计 -->
  <view class="header">
    <view class="title">历史记录</view>
    <view class="stats">
      <text class="count">{{totalCount}}条记录</text>
      <text class="limit">（最多保存30条）</text>
    </view>
  </view>

  <!-- 记录列表 -->
  <view class="records-list" wx:if="{{records.length > 0}}">
    <view
      class="record-item"
      wx:for="{{records}}"
      wx:key="id"
      bindtap="onRecordTap"
      data-id="{{item.id}}"
    >
      <!-- 记录基本信息 -->
      <view class="record-header">
        <view class="user-info">
          <text class="name">{{item.name}}</text>
          <text class="gender">{{item.gender === 'male' ? '男' : '女'}}</text>
        </view>
        <view class="record-actions" catchtap="onDeleteRecord" data-id="{{item.id}}">
          <text class="delete-btn">删除</text>
        </view>
      </view>

      <!-- 生辰信息 -->
      <view class="birth-info">
        <text class="birthday">{{item.birthday}}</text>
        <text class="location">{{item.location.province}} {{item.location.city}}</text>
      </view>

      <!-- 八字简览 -->
      <view class="bazi-preview">
        <view class="bazi-row" wx:if="{{item.baziData && item.baziData.yearPillar}}">
          <text class="pillar-label">年柱</text>
          <text class="pillar-content">{{item.baziData.yearPillar.heavenlyStem}}{{item.baziData.yearPillar.earthlyBranch}}</text>
        </view>
        <view class="bazi-row" wx:if="{{item.baziData && item.baziData.monthPillar}}">
          <text class="pillar-label">月柱</text>
          <text class="pillar-content">{{item.baziData.monthPillar.heavenlyStem}}{{item.baziData.monthPillar.earthlyBranch}}</text>
        </view>
        <view class="bazi-row" wx:if="{{item.baziData && item.baziData.dayPillar}}">
          <text class="pillar-label">日柱</text>
          <text class="pillar-content">{{item.baziData.dayPillar.heavenlyStem}}{{item.baziData.dayPillar.earthlyBranch}}</text>
        </view>
        <view class="bazi-row" wx:if="{{item.baziData && item.baziData.hourPillar}}">
          <text class="pillar-label">时柱</text>
          <text class="pillar-content">{{item.baziData.hourPillar.heavenlyStem}}{{item.baziData.hourPillar.earthlyBranch}}</text>
        </view>
      </view>

      <!-- AI结果预览 -->
      <view class="ai-preview" wx:if="{{item.aiResult}}">
        <text class="preview-text">{{item.aiResult.substring(0, 100)}}{{item.aiResult.length > 100 ? '...' : ''}}</text>
      </view>

      <!-- 时间戳 -->
      <view class="record-footer">
        <text class="timestamp">{{item.createdAtFormatted}}</text>
        <text class="view-detail">查看详情 ></text>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{records.length === 0 && !loading}}">
    <image class="empty-icon" src="/images/empty-history.png" mode="aspectFit"></image>
    <text class="empty-text">暂无历史记录</text>
    <text class="empty-desc">完成测算后会自动保存在这里</text>
    <button class="empty-action" bindtap="navigateToIndex">立即测算</button>
  </view>

  <!-- 加载状态 -->
  <view class="loading-more" wx:if="{{loading}}">
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 没有更多数据 -->
  <view class="no-more" wx:if="{{!hasMore && records.length > 0}}">
    <text class="no-more-text">没有更多记录了</text>
  </view>

  <!-- 删除确认弹窗 -->
  <view class="delete-modal" wx:if="{{showDeleteConfirm}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">确认删除</text>
      </view>
      <view class="modal-body">
        <text class="modal-text">确定要删除这条记录吗？删除后无法恢复。</text>
      </view>
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="cancelDelete">取消</button>
        <button class="modal-btn confirm" bindtap="confirmDelete">删除</button>
      </view>
    </view>
    <view class="modal-mask" bindtap="cancelDelete"></view>
  </view>
</view>